<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>divs.lua</title>
  <link rel="stylesheet" href="pycco.css">
<script src="https://kit.fontawesome.com/7abee6b155.js" crossorigin="anonymous"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async 
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                  inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                  processEscapes: true
            }
        });
</script>
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><center>
<a href="index.html">home</a> :: 
<a href="about.html">about</a> :: 
<a href="https://github.com/timm/lua/tree/master/INSTALL.md">install</a> :: 
<a href="https://github.com/timm/lua/tree/master/test">demos</a> :: 
<a href="http://github.com/timm/lua">github</a>   :: 
<a href="http://github.com/timm/lua/issues>discuss"</a>  
<a href="https://github.com/timm/lua/blob/master/LICENSE.md">&copy; 2020</a> by
<a href="http://menzies.us">timm</a>
<hr>
<h2>DUO =  Data Miners using and/or used-by Optimizers</h2><h1>divs.lua</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <center><hr>
<a href="https://www.lua.org"><img 
      src=https://img.shields.io/badge/language-lua-orange></a>
<img  src=https://img.shields.io/badge/purpose-teach,ai,se-blueviolet> 
<img  src=https://img.shields.io/badge/platform-mac,*nux-informational> 
<a    href="https://travis-ci.org/timm/lua"><img 
      src=https://travis-ci.org/timm/lua.svg?branch=master></a>
      </center>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p><img align=right src="https://github.com/timm/lua/raw/master/etc/img/divs.jpg"></p>
<p>This file returns a function that
divides a list of numbers such that the variability
of each division is minimized. </p>
<p>To simplify that task, we sort the numbers once
then measure variance using the 10th and 90th percentile 
of that list. This has the advantage that, if we recurse
into some part of that list, then we can quickly estimate
the variance of that sublist using that list&rsquo;s 10th and 90th
percentile.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;lib&quot;</span>
<span class="kd">local</span> <span class="n">THE</span><span class="o">=</span><span class="nb">require</span><span class="p">(</span><span class="s2">&quot;the&quot;</span><span class="p">).</span><span class="n">divs</span>

<span class="kd">local</span> <span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">xpect</span> <span class="c1">-- functions</span>

<span class="kr">function</span> <span class="nf">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>       <span class="kr">return</span> <span class="n">a</span><span class="p">[</span><span class="nb">math.floor</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span> <span class="kr">end</span>
<span class="kr">function</span> <span class="nf">p</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>       <span class="kr">return</span> <span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">z</span><span class="o">*#</span><span class="n">i</span><span class="p">.</span><span class="n">has</span> <span class="p">)</span> <span class="kr">end</span>
<span class="kr">function</span> <span class="nf">mid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span> <span class="kr">return</span> <span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">lo</span> <span class="o">+</span> <span class="mf">.5</span><span class="o">*</span><span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span><span class="p">)</span> <span class="p">)</span> <span class="kr">end</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>On experimentation, we found dividing the 90th minus
10th percentile by 2.7 returns a value close to the normal
Gaussian variance.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kr">function</span> <span class="nf">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span> 
  <span class="kr">return</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="o">+</span><span class="mf">.9</span><span class="o">*</span><span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span><span class="p">))</span> <span class="o">-</span> <span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="o">+</span><span class="mf">.1</span><span class="o">*</span><span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span><span class="p">)))</span><span class="o">/</span><span class="mf">2.7</span> <span class="kr">end</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>The expected value of two <code>Some</code>s is the weighed sum of
their variances.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kr">function</span> <span class="nf">xpect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="n">lo</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="o">-</span><span class="n">j</span> <span class="p">,</span> <span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="kr">return</span> <span class="n">n1</span><span class="o">/</span><span class="n">n</span> <span class="o">*</span> <span class="n">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">n2</span><span class="o">/</span><span class="n">n</span> <span class="o">*</span> <span class="n">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span> <span class="kr">end</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>When we seek divisions, 
ignore divisions that are too small (less than, say,
square root size of the list&ndash; see the <code>step</code> var);
or that divide the numbers into bins of size less 
than <code>epsilon</code>
(less than 30% of the standard deviation).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kr">return</span> <span class="kr">function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="nb">table.sort</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">cuts</span>    <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">step</span>    <span class="o">=</span> <span class="nb">math.floor</span><span class="p">((</span><span class="o">#</span><span class="n">a</span><span class="p">)</span><span class="o">^</span><span class="n">THE</span><span class="p">.</span><span class="n">step</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">THE</span><span class="p">.</span><span class="n">cohen</span>
  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">div</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">,</span>     <span class="n">cut</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">best</span> <span class="o">=</span> <span class="n">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span>
    <span class="kr">for</span> <span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="n">hi</span><span class="o">-</span><span class="n">step</span> <span class="kr">do</span>
      <span class="kd">local</span> <span class="n">now</span><span class="p">,</span> <span class="n">after</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">x</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
      <span class="kr">if</span> <span class="n">now</span> <span class="o">~=</span> <span class="n">after</span> <span class="kr">then</span> 
        <span class="kr">if</span> <span class="n">after</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">epsilon</span> <span class="kr">then</span>
          <span class="kr">if</span> <span class="n">a</span><span class="p">[</span><span class="o">#</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">epsilon</span> <span class="kr">then</span>
            <span class="kr">if</span> <span class="nb">math.abs</span><span class="p">(</span> <span class="n">mid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">mid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span> <span class="kr">then</span>
              <span class="kd">local</span> <span class="n">new</span> <span class="o">=</span> <span class="n">xpect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">lo</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Ignore new divisions that improve things
by less than a <code>trivial</code> amount
(say, 5%).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>              <span class="kr">if</span> <span class="n">new</span> <span class="o">*</span> <span class="n">THE</span><span class="p">.</span><span class="n">trivial</span> <span class="o">&lt;</span> <span class="n">best</span> <span class="kr">then</span>
                 <span class="n">best</span><span class="p">,</span><span class="n">cut</span> <span class="o">=</span> <span class="n">new</span><span class="p">,</span><span class="n">j</span> <span class="kr">end</span> <span class="kr">end</span> <span class="kr">end</span> <span class="kr">end</span> <span class="kr">end</span>  <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">cut</span>  
  <span class="kr">end</span> <span class="c1">-- end div</span>
  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">,</span>  <span class="n">cut</span><span class="p">)</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span><span class="n">hi</span><span class="p">)</span>
    <span class="kr">if</span>   <span class="n">cut</span> 
    <span class="kr">then</span> <span class="n">recurse</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>
         <span class="n">recurse</span><span class="p">(</span><span class="n">cut</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span> 
    <span class="kr">else</span> <span class="n">cuts</span><span class="p">[</span> <span class="o">#</span><span class="n">cuts</span><span class="o">+</span><span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="kr">end</span>  
  <span class="kr">end</span> <span class="c1">-- end recurse</span>
  <span class="n">recurse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">a</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">cuts</span>
<span class="kr">end</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
